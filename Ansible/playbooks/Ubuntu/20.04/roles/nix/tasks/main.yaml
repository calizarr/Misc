---
- name: nix - download shell script
  ansible.builtin.get_url:
    url: https://nixos.org/nix/install
    dest: "{{ ansible_env.HOME }}/Downloads/nix_install.sh"
    mode: u=rwx,g=rwx,o=r
  register: nix_env_sh

- name: nix - install
  ansible.builtin.expect:
    command: "bash {{ nix_env_sh.dest }}"
    creates: /nix
    responses:
      (?i)password: "{{ ansible_become_pass }}"
  environment:
    - NIX_INSTALLER_NO_MODIFY_PROFILE: 1

- name: nix - add nix to .bashrc
  ansible.builtin.blockinfile:
    path: "{{ bash_rc }}"
    block: "{{ nix_init }}"
    state: present
    marker_begin: "NIX BEGIN"
    marker_end: "NIX END"

- name: nix - install packages
  command: "nix-env --install --attr {{ nix_packages | join (' ') }}"
